<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ma garde-robe | M3 Style</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwindcss.config = {
      theme: { extend: { colors: { brand: { 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' } } } }
    }
  </script>
  <style>
    html { font-size: 18px; }
    @media (max-width: 768px) { html { font-size: 16px; } }
    body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
    h1, h2, h3, .font-display { font-family: 'Space Grotesk', sans-serif; }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-[#05050a] min-h-screen">

  <!-- Header -->
  <header class="border-b border-white/5 bg-[#05050a]/95 sticky top-0 z-50 backdrop-blur-sm">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <div class="w-10 h-10 bg-brand-500 rounded-xl flex items-center justify-center"><span class="text-xl">ðŸ‘”</span></div>
        <span class="text-xl font-bold text-white">M3 <span class="text-brand-400">STYLE</span></span>
      </a>
      <div class="flex items-center gap-4">
        <a href="/dashboard.html" class="text-slate-400 hover:text-white text-sm">Tableau de bord</a>
        <a href="/stylist.html" class="text-slate-400 hover:text-white text-sm">Styliste IA</a>
        <a href="/marketplace.html" class="text-slate-400 hover:text-white text-sm">Designers</a>
        <a href="/profile.html" class="text-slate-400 hover:text-white text-sm">Mon profil</a>
        <button onclick="logout()" class="text-slate-400 hover:text-white text-sm">DÃ©connexion</button>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-6 py-8">

    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold text-white">Ma garde-robe</h1>
        <p class="text-slate-300 mt-1"><span id="itemCount">0</span> articles enregistrÃ©s</p>
      </div>
      <button onclick="openAddModal()" class="bg-brand-500 hover:bg-brand-600 text-white px-6 py-3 rounded-lg font-bold text-sm transition-colors">+ Ajouter un article</button>
    </div>

    <!-- Filter -->
    <div class="flex items-center gap-3 mb-6 flex-wrap">
      <button class="filter-btn px-4 py-2 bg-brand-500 border border-brand-500 text-white rounded-lg text-sm font-medium" onclick="filterCategory('')" data-cat="">Tous</button>
      <button class="filter-btn px-4 py-2 border border-white/10 text-slate-300 rounded-lg text-sm font-medium hover:border-brand-500/30" onclick="filterCategory('tops')" data-cat="tops">Hauts</button>
      <button class="filter-btn px-4 py-2 border border-white/10 text-slate-300 rounded-lg text-sm font-medium hover:border-brand-500/30" onclick="filterCategory('bottoms')" data-cat="bottoms">Bas</button>
      <button class="filter-btn px-4 py-2 border border-white/10 text-slate-300 rounded-lg text-sm font-medium hover:border-brand-500/30" onclick="filterCategory('outerwear')" data-cat="outerwear">Manteaux</button>
      <button class="filter-btn px-4 py-2 border border-white/10 text-slate-300 rounded-lg text-sm font-medium hover:border-brand-500/30" onclick="filterCategory('shoes')" data-cat="shoes">Chaussures</button>
      <button class="filter-btn px-4 py-2 border border-white/10 text-slate-300 rounded-lg text-sm font-medium hover:border-brand-500/30" onclick="filterCategory('accessories')" data-cat="accessories">Accessoires</button>
      <button class="filter-btn px-4 py-2 border border-white/10 text-slate-300 rounded-lg text-sm font-medium hover:border-brand-500/30" onclick="filterCategory('suits')" data-cat="suits">Costumes</button>
    </div>

    <!-- Items Grid -->
    <div id="wardrobeGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
      <!-- Dynamic items -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-20">
      <div class="text-6xl mb-4 opacity-30">ðŸ‘”</div>
      <h2 class="text-xl font-bold text-white mb-2">Votre garde-robe est vide</h2>
      <p class="text-slate-400 mb-6">Ajoutez vos vÃªtements pour que le styliste IA puisse crÃ©er des looks avec ce que vous possÃ©dez dÃ©jÃ .</p>
      <button onclick="openAddModal()" class="bg-brand-500 hover:bg-brand-600 text-white px-6 py-3 rounded-lg font-bold text-sm transition-colors">+ Ajouter mon premier article</button>
    </div>
  </div>

  <!-- Add Item Modal -->
  <div id="addModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" style="display:none;">
    <div class="bg-[#0d0d14] border border-white/5 rounded-2xl p-8 max-w-lg w-full fade-in relative max-h-[90vh] overflow-y-auto">
      <button onclick="closeAddModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <h2 class="text-2xl font-bold text-white mb-6">Ajouter un article</h2>

      <!-- Photo Upload -->
      <div id="photoUploadArea" class="mb-6">
        <label class="block text-sm font-medium text-slate-300 mb-3">Photographiez votre vÃªtement</label>
        <div id="dropZone" class="border-2 border-dashed border-white/10 hover:border-brand-500/40 rounded-2xl p-8 text-center cursor-pointer transition-colors" onclick="document.getElementById('photoInput').click()">
          <div id="dropContent">
            <div class="text-4xl mb-3">ðŸ“¸</div>
            <p class="text-slate-300 font-medium mb-1">Cliquez ou glissez une photo</p>
            <p class="text-slate-400 text-sm">Yves analysera le vÃªtement automatiquement</p>
          </div>
          <div id="photoPreview" style="display:none" class="relative">
            <img id="previewImg" class="max-h-48 mx-auto rounded-xl">
            <button type="button" onclick="event.stopPropagation(); clearPhoto()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm hover:bg-red-600">âœ•</button>
          </div>
        </div>
        <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(this)">
        <div id="analyzeStatus" class="mt-3 text-center hidden">
          <div class="inline-flex items-center gap-2 text-brand-400">
            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
            <span>Yves analyse le vÃªtement...</span>
          </div>
        </div>
      </div>

      <!-- Divider -->
      <div class="flex items-center gap-3 mb-5"><div class="flex-1 h-px bg-white/5"></div><span class="text-slate-400 text-sm">DÃ©tails du vÃªtement</span><div class="flex-1 h-px bg-white/5"></div></div>

      <form onsubmit="addItem(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Nom de l'article</label>
          <input type="text" id="itemName" required class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-brand-500 focus:border-brand-500" placeholder="Ex: Blazer marine Hugo Boss">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">CatÃ©gorie *</label>
            <select id="itemCategory" required class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-brand-500">
              <option value="">Choisir...</option>
              <option value="tops">Haut (chemise, t-shirt, polo)</option>
              <option value="bottoms">Bas (pantalon, jeans, shorts)</option>
              <option value="outerwear">Manteau / Veste</option>
              <option value="shoes">Chaussures</option>
              <option value="suits">Costume / Blazer</option>
              <option value="accessories">Accessoire</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Sous-catÃ©gorie</label>
            <input type="text" id="itemSubcategory" class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-brand-500 focus:border-brand-500" placeholder="Ex: blazer, jeans, etc.">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Couleur principale</label>
            <input type="text" id="itemColor" class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-brand-500 focus:border-brand-500" placeholder="Marine">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Marque</label>
            <input type="text" id="itemBrand" class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-brand-500 focus:border-brand-500" placeholder="Hugo Boss">
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Taille</label>
            <input type="text" id="itemSize" class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-brand-500 focus:border-brand-500" placeholder="M, L, 32...">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">MatÃ©riau</label>
            <input type="text" id="itemMaterial" class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-brand-500 focus:border-brand-500" placeholder="Laine, coton...">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Coupe</label>
            <select id="itemFit" class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-brand-500">
              <option value="">â€”</option>
              <option value="slim">Slim</option>
              <option value="regular">Regular</option>
              <option value="relaxed">Relaxed</option>
              <option value="oversized">Oversized</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Motif</label>
          <select id="itemPattern" class="w-full px-4 py-3 bg-[#05050a] border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-brand-500">
            <option value="">Uni / Aucun</option>
            <option value="rayures">Rayures</option>
            <option value="carreaux">Carreaux</option>
            <option value="pois">Pois</option>
            <option value="floral">Floral</option>
            <option value="geometrique">GÃ©omÃ©trique</option>
            <option value="autre">Autre</option>
          </select>
        </div>
        <div id="addError" class="text-red-400 text-sm hidden"></div>
        <button type="submit" id="addBtn" class="w-full py-3 bg-brand-500 hover:bg-brand-600 text-white font-bold rounded-lg transition-colors">Ajouter Ã  ma garde-robe</button>
      </form>
    </div>
  </div>

  <script>
    let currentPhotoBase64 = null;

    function handlePhoto(input) {
      var file = input.files[0];
      if (!file) return;
      
      var reader = new FileReader();
      reader.onload = function(e) {
        // Compress image to max 800px before sending
        var img = new Image();
        img.onload = function() {
          var canvas = document.createElement('canvas');
          var maxSize = 512;
          var w = img.width, h = img.height;
          if (w > maxSize || h > maxSize) {
            if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
            else { w = Math.round(w * maxSize / h); h = maxSize; }
          }
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.5);
          document.getElementById('dropContent').style.display = 'none';
          document.getElementById('photoPreview').style.display = 'block';
          document.getElementById('previewImg').src = currentPhotoBase64;
          analyzePhoto(currentPhotoBase64);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function clearPhoto() {
      currentPhotoBase64 = null;
      document.getElementById('dropContent').style.display = 'block';
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('photoInput').value = '';
      document.getElementById('analyzeStatus').classList.add('hidden');
    }

    async function analyzePhoto(base64) {
      var status = document.getElementById('analyzeStatus');
      status.classList.remove('hidden');
      status.innerHTML = '<div class="inline-flex items-center gap-2 text-brand-400"><svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg><span>Yves analyse le vetement...</span></div>';

      try {
        console.log('Sending image, size:', Math.round(base64.length / 1024) + 'KB');
        var res = await fetch('/api/wardrobe/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ image_base64: base64 })
        });
        console.log('Response status:', res.status);
        
        if (!res.ok) {
          var errText = await res.text();
          console.error('API error:', res.status, errText);
          status.innerHTML = '<span class="text-amber-400">Erreur serveur (' + res.status + ') â€” remplissez manuellement</span>';
          return;
        }

        var data = await res.json();
        console.log('Analysis result:', data);
        
        if (data.analysis) {
          var a = data.analysis;
          if (a.name) document.getElementById('itemName').value = a.name;
          if (a.category) document.getElementById('itemCategory').value = a.category;
          if (a.subcategory) document.getElementById('itemSubcategory').value = a.subcategory;
          if (a.color_primary) document.getElementById('itemColor').value = a.color_primary;
          if (a.brand && a.brand !== 'null' && a.brand !== null) document.getElementById('itemBrand').value = a.brand;
          if (a.material) document.getElementById('itemMaterial').value = a.material;
          if (a.size) document.getElementById('itemSize').value = a.size;
          if (a.fit) document.getElementById('itemFit').value = a.fit;
          if (a.pattern && a.pattern !== 'null' && a.pattern !== null) document.getElementById('itemPattern').value = a.pattern;
          
          status.innerHTML = '<span class="text-emerald-400 font-medium">&#x2713; Analyse par Yves â€” verifiez et ajustez si besoin</span>';
        } else {
          console.error('No analysis in response:', data);
          status.innerHTML = '<span class="text-amber-400">Analyse incomplete (' + (data.error || 'reponse vide') + ')</span>';
        }
      } catch(err) {
        console.error('Analyze error:', err);
        status.innerHTML = '<span class="text-amber-400">Erreur de connexion â€” remplissez manuellement</span>';
      }
    }

    // Drag and drop support
    var dropZone = document.getElementById('dropZone');
    if (dropZone) {
      dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.style.borderColor = 'rgba(139,92,246,0.5)'; });
      dropZone.addEventListener('dragleave', function() { dropZone.style.borderColor = ''; });
      dropZone.addEventListener('drop', function(e) {
        e.preventDefault(); dropZone.style.borderColor = '';
        var file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          var dt = new DataTransfer(); dt.items.add(file);
          document.getElementById('photoInput').files = dt.files;
          handlePhoto(document.getElementById('photoInput'));
        }
      });
    }

    const token = localStorage.getItem('auth_token');
    if (!token) window.location.href = '/';

    let allItems = [];
    let currentFilter = '';

    const CATEGORY_ICONS = { tops: 'ðŸ‘•', bottoms: 'ðŸ‘–', outerwear: 'ðŸ§¥', shoes: 'ðŸ‘ž', suits: 'ðŸ¤µ', accessories: 'âŒš' };
    const CATEGORY_LABELS = { tops: 'Haut', bottoms: 'Bas', outerwear: 'Manteau', shoes: 'Chaussures', suits: 'Costume', accessories: 'Accessoire' };

    async function loadWardrobe() {
      try {
        const res = await fetch('/api/wardrobe', { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) throw new Error('Load failed');
        const data = await res.json();
        allItems = data.items || [];
        renderItems();
      } catch(e) { console.log('Wardrobe not loaded:', e); }
    }

    function renderItems() {
      const filtered = currentFilter ? allItems.filter(i => i.category === currentFilter) : allItems;
      document.getElementById('itemCount').textContent = allItems.length;

      if (filtered.length === 0) {
        document.getElementById('wardrobeGrid').innerHTML = '';
        document.getElementById('emptyState').classList.remove('hidden');
        return;
      }

      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('wardrobeGrid').innerHTML = filtered.map(item => `
        <div class="bg-[#0d0d14] border border-white/5 rounded-xl overflow-hidden hover:border-brand-500/30 transition-all group cursor-pointer" onclick="viewItem(${item.id})">
          <div class="aspect-square bg-[#05050a] flex items-center justify-center text-4xl">
            ${item.image_url ? `<img src="${item.image_url}" class="w-full h-full object-cover">` : CATEGORY_ICONS[item.category] || 'ðŸ‘”'}
          </div>
          <div class="p-3">
            <div class="text-white text-sm font-medium truncate">${item.name || CATEGORY_LABELS[item.category] || item.category}</div>
            <div class="text-slate-400 text-xs mt-1">${[item.color_primary, item.brand].filter(Boolean).join(' Â· ') || item.category}</div>
          </div>
          <div class="px-3 pb-3 flex gap-2">
            <button onclick="event.stopPropagation(); toggleFavorite(${item.id}, ${!item.is_favorite})" class="text-xs ${item.is_favorite ? 'text-brand-400' : 'text-slate-400 hover:text-brand-400'} transition-colors">
              ${item.is_favorite ? 'â˜…' : 'â˜†'} Favori
            </button>
            <button onclick="event.stopPropagation(); deleteItem(${item.id})" class="text-xs text-slate-400 hover:text-red-400 transition-colors ml-auto">Supprimer</button>
          </div>
        </div>
      `).join('');
    }

    function filterCategory(cat) {
      currentFilter = cat;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        const isActive = btn.dataset.cat === cat;
        btn.className = `filter-btn px-4 py-2 rounded-lg font-medium transition-colors ${isActive ? 'bg-brand-500 border border-brand-500 text-white' : 'border border-white/10 text-slate-300 hover:border-brand-500/30'}`;
      });
      renderItems();
    }

    function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }
    function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }

    async function addItem(e) {
      e.preventDefault();
      const btn = document.getElementById('addBtn');
      const error = document.getElementById('addError');
      btn.disabled = true; btn.textContent = 'Ajout...'; error.classList.add('hidden');

      try {
        const res = await fetch('/api/wardrobe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({
            name: document.getElementById('itemName').value,
            category: document.getElementById('itemCategory').value,
            subcategory: document.getElementById('itemSubcategory').value || null,
            color_primary: document.getElementById('itemColor').value || null,
            brand: document.getElementById('itemBrand').value || null,
            size: document.getElementById('itemSize').value || null,
            material: document.getElementById('itemMaterial').value || null,
            fit: document.getElementById('itemFit').value || null,
            pattern: document.getElementById('itemPattern').value || null,
            image_url: currentPhotoBase64 || null,
          })
        });
        if (!res.ok) { const d = await res.json(); throw new Error(d.error || 'Failed'); }
        closeAddModal();
        // Reset form + photo
        document.querySelectorAll('#addModal input, #addModal select').forEach(el => { if (el.type !== 'submit' && el.type !== 'file') el.value = ''; });
        clearPhoto();
        loadWardrobe();
      } catch(err) { error.textContent = err.message; error.classList.remove('hidden'); }
      finally { btn.disabled = false; btn.textContent = 'Ajouter Ã  ma garde-robe'; }
    }

    async function toggleFavorite(id, isFav) {
      try {
        await fetch('/api/wardrobe', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ id, is_favorite: isFav })
        });
        loadWardrobe();
      } catch(e) { console.error(e); }
    }

    async function deleteItem(id) {
      if (!confirm('Supprimer cet article?')) return;
      try {
        await fetch('/api/wardrobe?id=' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        loadWardrobe();
      } catch(e) { console.error(e); }
    }

    function viewItem(id) { /* TODO: item detail modal */ }
    function logout() { localStorage.removeItem('auth_token'); window.location.href = '/'; }

    // Auto-open add modal if ?add=true
    if (new URLSearchParams(window.location.search).get('add') === 'true') openAddModal();
    loadWardrobe();

    document.getElementById('addModal').addEventListener('click', function(e) { if (e.target === this) closeAddModal(); });
  </script>
<script src="/yves-helper.js"></script>
</body>
</html>
