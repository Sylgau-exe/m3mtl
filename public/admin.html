<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | M3 Style</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwindcss.config = {
      theme: {
        extend: {
          colors: {
            brand: { 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
    h1, h2, h3, .font-display { font-family: 'Space Grotesk', sans-serif; }
    @keyframes countUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .animate-in { animation: countUp 0.5s ease forwards; }
    .slide-in { animation: slideIn 0.3s ease forwards; opacity: 0; }
    .slide-in:nth-child(1) { animation-delay: 0.05s; }
    .slide-in:nth-child(2) { animation-delay: 0.1s; }
    .slide-in:nth-child(3) { animation-delay: 0.15s; }
    .slide-in:nth-child(4) { animation-delay: 0.2s; }
    .slide-in:nth-child(5) { animation-delay: 0.25s; }
    .skeleton { background: linear-gradient(90deg, #0d0d14 25%, rgba(255,255,255,0.1) 50%, #0d0d14 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 12px; }
    .stat-card { transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; overflow: hidden; }
    .stat-card:hover { transform: translateY(-4px); }
    .stat-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%); pointer-events: none; }
  </style>
</head>
<body class="bg-[#05050a] min-h-screen">

  <!-- Header -->
  <header class="border-b border-white/5 bg-[#05050a]/95 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <div class="w-10 h-10 bg-brand-500 rounded-xl flex items-center justify-center">
          <span class="text-xl">üëî</span>
        </div>
        <span class="text-xl font-bold text-white">M3 <span class="text-brand-500">STYLE</span></span>
      </a>
      <div id="headerNav" class="flex items-center gap-4">
        <span class="text-xs px-2 py-1 bg-brand-500/20 text-brand-400 rounded-full font-semibold">ADMIN</span>
        <a href="/" class="text-slate-400 hover:text-white text-sm">Accueil</a>
        <a href="/dashboard.html" class="text-slate-400 hover:text-white text-sm">Tableau de bord</a>
        <button onclick="logout()" class="text-slate-400 hover:text-white text-sm">D√©connexion</button>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  <div id="loading" class="max-w-7xl mx-auto px-6 py-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="skeleton h-32"></div><div class="skeleton h-32"></div>
      <div class="skeleton h-32"></div><div class="skeleton h-32"></div>
    </div>
    <div class="skeleton h-16 mb-4"></div>
    <div class="skeleton h-12 mb-2"></div><div class="skeleton h-12 mb-2"></div><div class="skeleton h-12 mb-2"></div>
  </div>

  <!-- Access Denied -->
  <div id="accessDenied" class="hidden max-w-md mx-auto mt-20 text-center">
    <div class="text-6xl mb-4">üîí</div>
    <h2 class="text-2xl font-bold text-white mb-2">Admin Access Required</h2>
    <p class="text-slate-400 mb-6">You don't have permission to view this page.</p>
    <a href="/" class="text-brand-500 hover:text-brand-400">‚Üê Back to Home</a>
  </div>

  <!-- Dashboard Content -->
  <div id="dashboard" class="hidden max-w-7xl mx-auto px-6 py-8">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold text-white">Admin Dashboard</h1>
        <p class="text-slate-400 mt-1">Manage users and view platform analytics</p>
      </div>
      <div class="text-sm text-slate-500">Last updated: <span id="lastUpdated"></span></div>
    </div>

    <!-- Stat Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="stat-card bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg shadow-indigo-500/20">
        <div class="text-sm opacity-80 uppercase tracking-wide font-medium mb-1">Total Users</div>
        <div id="statUsers" class="text-4xl font-bold animate-in">-</div>
        <div id="statUsers7d" class="mt-3 text-xs bg-white/20 inline-block px-2 py-1 rounded-full"></div>
      </div>
      <div class="stat-card bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl p-6 text-white shadow-lg shadow-blue-500/20">
        <div class="text-sm opacity-80 uppercase tracking-wide font-medium mb-1">Assessments</div>
        <div id="statAssessments" class="text-4xl font-bold animate-in">-</div>
        <div id="statAssessments7d" class="mt-3 text-xs bg-white/20 inline-block px-2 py-1 rounded-full"></div>
      </div>
      <div class="stat-card bg-gradient-to-br from-emerald-500 to-teal-500 rounded-2xl p-6 text-white shadow-lg shadow-emerald-500/20">
        <div class="text-sm opacity-80 uppercase tracking-wide font-medium mb-1">Avg Score</div>
        <div id="statAvgScore" class="text-4xl font-bold animate-in">-</div>
        <div class="mt-3 text-xs opacity-70">out of 100</div>
      </div>
      <div class="stat-card bg-gradient-to-br from-rose-500 to-pink-500 rounded-2xl p-6 text-white shadow-lg shadow-rose-500/20">
        <div class="text-sm opacity-80 uppercase tracking-wide font-medium mb-1">Partner Leads</div>
        <div id="statLeads" class="text-4xl font-bold animate-in">-</div>
        <div id="statAvgGaps" class="mt-3 text-xs bg-white/20 inline-block px-2 py-1 rounded-full"></div>
      </div>
    </div>

    <!-- Users Section -->
    <div class="bg-[#0d0d14] border border-white/5 rounded-2xl overflow-hidden">
      <div class="p-6 border-b border-white/5 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <h2 class="text-xl font-bold text-white">Users</h2>
        <div class="flex items-center gap-3 w-full sm:w-auto">
          <input type="text" id="searchInput" placeholder="Search users..." 
            class="flex-1 sm:w-64 px-4 py-2 bg-[#05050a] border border-white/10 rounded-lg text-white placeholder-slate-500 text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none"
            oninput="filterUsers()">
          <select id="filterProvider" onchange="filterUsers()" class="px-3 py-2 bg-[#05050a] border border-white/10 rounded-lg text-white text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
            <option value="">All Providers</option>
            <option value="email">Email</option>
            <option value="google">Google</option>
          </select>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="text-left text-xs uppercase tracking-wider text-slate-500 border-b border-white/5">
              <th class="px-6 py-4 font-semibold">User</th>
              <th class="px-6 py-4 font-semibold">Organization</th>
              <th class="px-6 py-4 font-semibold">Provider</th>
              <th class="px-6 py-4 font-semibold">Assessments</th>
              <th class="px-6 py-4 font-semibold">Avg Score</th>
              <th class="px-6 py-4 font-semibold">Joined</th>
              <th class="px-6 py-4 font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
          </tbody>
        </table>
      </div>

      <div id="userCount" class="px-6 py-4 border-t border-white/5 text-sm text-slate-500"></div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="editModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" style="display:none;">
    <div class="bg-[#0d0d14] border border-white/5 rounded-2xl p-8 max-w-md w-full relative">
      <button onclick="closeEditModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <h3 class="text-xl font-bold text-white mb-6">Edit User</h3>
      <input type="hidden" id="editUserId">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1">Name</label>
          <input type="text" id="editName" class="w-full px-4 py-2.5 bg-[#05050a] border border-white/10 rounded-lg text-white text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1">Email</label>
          <input type="email" id="editEmail" class="w-full px-4 py-2.5 bg-[#05050a] border border-white/10 rounded-lg text-white text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1">Organization</label>
          <input type="text" id="editOrg" class="w-full px-4 py-2.5 bg-[#05050a] border border-white/10 rounded-lg text-white text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1">Job Title</label>
          <input type="text" id="editTitle" class="w-full px-4 py-2.5 bg-[#05050a] border border-white/10 rounded-lg text-white text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
        </div>
        <div class="flex items-center gap-3">
          <input type="checkbox" id="editAdmin" class="w-4 h-4 accent-brand-500">
          <label for="editAdmin" class="text-sm text-slate-300">Admin privileges</label>
        </div>
        <div id="editError" class="text-red-400 text-sm hidden"></div>
        <div class="flex gap-3 pt-2">
          <button onclick="saveUser()" id="editSaveBtn" class="flex-1 py-2.5 bg-brand-500 hover:bg-brand-600 text-white font-semibold rounded-lg text-sm transition-colors">
            Save Changes
          </button>
          <button onclick="closeEditModal()" class="px-4 py-2.5 bg-[#05050a] hover:bg-[rgba(255,255,255,0.1)] text-slate-300 rounded-lg text-sm transition-colors">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let authToken = localStorage.getItem('auth_token');
    let allUsers = [];

    function headers() { return { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }; }
    function logout() { localStorage.removeItem('auth_token'); window.location.href = '/'; }

    async function init() {
      if (!authToken) { showAccessDenied(); return; }

      try {
        // Verify admin
        const meRes = await fetch('/api/auth/me', { headers: headers() });
        if (!meRes.ok) { showAccessDenied(); return; }
        const meData = await meRes.json();
        if (!meData.user.isAdmin) { showAccessDenied(); return; }

        // Load data
        await Promise.all([loadStats(), loadUsers()]);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
      } catch (e) {
        console.error('Init error:', e);
        showAccessDenied();
      }
    }

    function showAccessDenied() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('accessDenied').classList.remove('hidden');
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/admin/stats', { headers: headers() });
        if (!res.ok) { console.error('Stats API error:', res.status, await res.text()); return; }
        const data = await res.json();
        animateCounter('statUsers', data.overview.totalUsers);
        animateCounter('statAssessments', data.overview.totalAssessments);
        animateCounter('statAvgScore', data.overview.avgOverallScore);
        animateCounter('statLeads', data.overview.totalLeads);
        document.getElementById('statUsers7d').textContent = `‚Üë ${data.last7Days.newUsers} this week`;
        document.getElementById('statAssessments7d').textContent = `‚Üë ${data.last7Days.assessments} this week`;
        document.getElementById('statAvgGaps').textContent = `~${data.overview.avgGapCount} avg gaps`;
      } catch (e) { console.error('Stats fetch error:', e); }
    }

    function animateCounter(id, target) {
      const el = document.getElementById(id);
      if (target === 0 || isNaN(target)) { el.textContent = '0'; return; }
      const duration = 800;
      const start = performance.now();
      function update(now) {
        const progress = Math.min((now - start) / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 4);
        el.textContent = Math.floor(eased * target);
        if (progress < 1) requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    }

    async function loadUsers() {
      try {
        const res = await fetch('/api/admin/users', { headers: headers() });
        if (!res.ok) return;
        const data = await res.json();
        allUsers = data.users;
        renderUsers(allUsers);
      } catch (e) { console.error('Users error:', e); }
    }

    function renderUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = users.map((u, i) => `
        <tr class="slide-in border-b border-white/5 hover:bg-[#05050a]/50 transition-colors" style="animation-delay: ${i * 0.03}s">
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-full bg-gradient-to-br from-brand-500 to-indigo-600 flex items-center justify-center text-white text-sm font-bold">
                ${u.name ? u.name.charAt(0).toUpperCase() : '?'}
              </div>
              <div>
                <div class="text-white text-sm font-medium flex items-center gap-2">
                  ${u.name || 'Unknown'}
                  ${u.isAdmin ? '<span class="text-xs px-1.5 py-0.5 bg-amber-500/20 text-amber-400 rounded font-semibold">ADMIN</span>' : ''}
                </div>
                <div class="text-slate-500 text-xs">${u.email}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-slate-400 text-sm">${u.organization}</td>
          <td class="px-6 py-4">
            <span class="text-xs px-2 py-1 rounded-full font-medium ${u.authProvider === 'google' ? 'bg-blue-500/20 text-blue-400' : 'bg-[#05050a] text-slate-400'}">
              ${u.authProvider === 'google' ? 'üîµ Google' : '‚úâÔ∏è Email'}
            </span>
          </td>
          <td class="px-6 py-4 text-center">
            <span class="text-white font-medium">${u.assessments}</span>
            ${u.avgScore > 0 ? `<span class="text-slate-500 text-xs ml-1">(avg ${u.avgScore})</span>` : ''}
          </td>
          <td class="px-6 py-4">
            ${u.avgScore > 0 ? `
              <div class="flex items-center gap-2">
                <div class="flex-1 h-2 bg-[#05050a] rounded-full overflow-hidden">
                  <div class="h-full rounded-full ${u.avgScore >= 70 ? 'bg-emerald-500' : u.avgScore >= 40 ? 'bg-amber-500' : 'bg-red-500'}" style="width: ${u.avgScore}%"></div>
                </div>
                <span class="text-sm text-slate-400 w-8">${u.avgScore}</span>
              </div>
            ` : '<span class="text-slate-600 text-sm">-</span>'}
          </td>
          <td class="px-6 py-4 text-slate-400 text-sm">${u.joined}</td>
          <td class="px-6 py-4">
            <div class="flex items-center gap-2">
              <button onclick='openEditModal(${JSON.stringify(u).replace(/'/g, "&#39;")})' class="px-3 py-1.5 bg-brand-500/20 hover:bg-brand-500/30 text-brand-400 rounded-lg text-xs font-medium transition-colors">
                Edit
              </button>
              <button onclick="deleteUser(${u.id}, '${u.email}')" class="px-3 py-1.5 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-xs font-medium transition-colors">
                Delete
              </button>
            </div>
          </td>
        </tr>
      `).join('');
      document.getElementById('userCount').textContent = `Showing ${users.length} of ${allUsers.length} users`;
    }

    function filterUsers() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const provider = document.getElementById('filterProvider').value;
      const filtered = allUsers.filter(u => {
        const matchSearch = !search || u.name?.toLowerCase().includes(search) || u.email.toLowerCase().includes(search) || u.organization?.toLowerCase().includes(search);
        const matchProvider = !provider || u.authProvider === provider;
        return matchSearch && matchProvider;
      });
      renderUsers(filtered);
    }

    function openEditModal(user) {
      document.getElementById('editUserId').value = user.id;
      document.getElementById('editName').value = user.name || '';
      document.getElementById('editEmail').value = user.email || '';
      document.getElementById('editOrg').value = user.organization === '-' ? '' : user.organization || '';
      document.getElementById('editTitle').value = user.jobTitle === '-' ? '' : user.jobTitle || '';
      document.getElementById('editAdmin').checked = user.isAdmin;
      document.getElementById('editError').classList.add('hidden');
      document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    async function saveUser() {
      const btn = document.getElementById('editSaveBtn');
      const error = document.getElementById('editError');
      btn.disabled = true; btn.textContent = 'Saving...';
      error.classList.add('hidden');

      try {
        const res = await fetch('/api/admin/edit-user', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({
            userId: parseInt(document.getElementById('editUserId').value),
            name: document.getElementById('editName').value,
            email: document.getElementById('editEmail').value,
            organization: document.getElementById('editOrg').value,
            jobTitle: document.getElementById('editTitle').value,
            isAdmin: document.getElementById('editAdmin').checked
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        closeEditModal();
        await loadUsers();
      } catch (err) {
        error.textContent = err.message; error.classList.remove('hidden');
      } finally {
        btn.disabled = false; btn.textContent = 'Save Changes';
      }
    }

    async function deleteUser(userId, email) {
      if (!confirm(`Delete user ${email}? This will also delete all their assessments. This cannot be undone.`)) return;
      try {
        const res = await fetch('/api/admin/delete-user', {
          method: 'DELETE',
          headers: headers(),
          body: JSON.stringify({ userId })
        });
        if (!res.ok) { const d = await res.json(); throw new Error(d.error); }
        await Promise.all([loadStats(), loadUsers()]);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    init();
  </script>
<script src="/yves-helper.js"></script>
</body>
</html>
